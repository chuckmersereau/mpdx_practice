<div class="row">
    <div class="col-sm-6">
        <h2 ng-if="$ctrl.type === 'donor'" translate>Contributions by Partner Currency</h2>
        <h2 ng-if="$ctrl.type === 'salary'" translate>Contributions by Salary Currency</h2>
    </div>
    <div class="col-sm-6 text-right report-action-buttons">
        <button class="btn btn-primary" ng-click="$ctrl.togglePageWidth()">
            <span ng-if="!$ctrl.expanded">
                <span translate>Expand partner info</span>
                    <i class="fa fa-expand" aria-hidden="true"></i>
                </span>
            <span ng-if="$ctrl.expanded">
            <span translate>Hide partner info</span>
                <i class="fa fa-compress" aria-hidden="true"></i>
            </span>
        </button>
        <button class="btn btn-default" ng-csv="$ctrl.currencyGroupsToCSV()" lazy-load="true"
                filename="mpdx-{{$ctrl.type}}-contributions-export-{{$ctrl.moment().format('Y-MM-DD-HH:mm')}}.csv"
                translate>
            Export CSV
        </button>
    </div>
</div>

<div ng-if="$ctrl.errorOccurred" translate>
    Report data could not load due to an error. Please try again or contact support.
</div>

<div ng-if="$ctrl.loading" translate>
    Loading data...
</div>

<uib-progress ng-if="!$ctrl.loading && !$ctrl.errorOccurred && $ctrl.type === 'donor'" class="report-progress-bar">
    <uib-bar ng-repeat="currencyGroup in $ctrl.currencyGroups"
             value="$ctrl.percentage(currencyGroup.yearTotalConverted)"
             type="color-{{$index % 6}}"
             uib-tooltip-template="'inline/currencyDonationsReport/progressBarTooltip.html'"
             tooltip-placement="bottom">
        <script type="text/ng-template" id="inline/currencyDonationsReport/progressBarTooltip.html">
            <div>
                {{currencyGroup.currencySymbol}}{{currencyGroup.yearTotal | number : 0}} {{currencyGroup.currency}}
            </div>
            <div>
                <span translate>Converted to</span>:
                {{currencyGroup.currencySymbolConverted}}{{currencyGroup.yearTotalConverted | number : 0}}
            </div>
            <div>
                ({{$ctrl.percentage(currencyGroup.yearTotalConverted) | number:0}}%
                <span translate>of total</span>
                {{currencyGroup.currencySymbolConverted}}{{$ctrl.sumOfAllCurrenciesConverted | number : 0}}
                {{currencyGroup.currencyConverted}})
            </div>
        </script>
        <span ng-if="$ctrl.percentage(currencyGroup.yearTotalConverted) > 7">
      {{currencyGroup.currency}} ({{currencyGroup.currencySymbol}})
    </span>
    </uib-bar>
</uib-progress>
<div class="panel panel-default panel-report" ng-if="!$ctrl.errorOccurred"
     ng-repeat="currencyGroup in $ctrl.currencyGroups">
    <div class="table-responsive">
        <table ng-if="!$ctrl.errorOccurred" class="table table-striped">
            <thead>
            <tr class="year-header-row">
                <th class="currency-title" colspan="{{$ctrl.expanded ? 5 : 1}}">
                    <span ng-if="!$ctrl.useConvertedValues">{{currencyGroup.currency}} ({{currencyGroup.currencySymbol}})</span>
                    <span ng-if="$ctrl.useConvertedValues">{{currencyGroup.currencyConverted}} ({{currencyGroup.currencySymbolConverted}})</span>
                </th>
                <th ng-repeat="(year, numberOfMonths) in $ctrl.years" colspan="{{numberOfMonths}}">
                    <div class="year-header-range">{{year}}</div>
                </th>
                <th>
                    <div class="year-header-range">&nbsp;</div>
                </th>
            </tr>
            <tr>
                <th translate>Partner</th>
                <th ng-if="$ctrl.expanded" translate>Status</th>
                <th ng-if="$ctrl.expanded" translate>Pledge</th>
                <th ng-if="$ctrl.expanded" translate>Avg</th>
                <th ng-if="$ctrl.expanded" translate>Min</th>
                <th class="text-right" ng-repeat="date in $ctrl.allMonths track by $index">
                    <div
                        uib-tooltip="{{$ctrl.gettextCatalog.getString('This last month is excluded from totals and averages') }}"
                        tooltip-enable="$last" ng-class="{'excluded': $last}">
                        {{$ctrl.moment(date).format('MMM')}}
                    </div>
                </th>
                <th class="text-right" translate>Total</th>
            </tr>
            </thead>
            <tbody>
            <tr ng-repeat="donor in currencyGroup.donors track by $index">
                <td>
                  <span class="donor-name" uib-tooltip-template="'inline/currencyDonationsReport/nameTooltip.html'"
                        tooltip-enable="!$ctrl.expanded">
                    <i class="fa fa-info-circle" aria-hidden="true" ng-if="!$ctrl.expanded"></i>
                    <a ui-sref="contact({ contactId: donor.donorInfo.id})" target="_blank">{{donor.donorInfo.name}}</a>
                  </span>
                    <script type="text/ng-template" id="inline/currencyDonationsReport/nameTooltip.html">
                        <div>{{donor.donorInfo.status}}</div>
                        <span ng-if="!$ctrl.useConvertedValues">
              {{currencyGroup.currencySymbol}}{{donor.donorInfo.pledge_amount | number:0}} {{currencyGroup.currency}} {{donor.donorInfo.pledge_frequency}}<br>
              Avg: {{currencyGroup.currencySymbol}}{{donor.aggregates.average | number:0}} / Min: {{currencyGroup.currencySymbol}}{{donor.aggregates.min | number:0}}
            </span>
                        <span ng-if="$ctrl.useConvertedValues">
              {{currencyGroup.currencySymbol}}{{donor.donorInfo.pledge_amount | number:0}} {{currencyGroup.currency}} {{donor.donorInfo.pledge_frequency}}<br>
              Avg: {{currencyGroup.currencySymbolConverted}}{{donor.aggregatesConverted.average | number:0}} / Min: {{currencyGroup.currencySymbolConverted}}{{donor.aggregatesConverted.min | number:0}}
            </span>
                    </script>
                    <span
                        ng-switch="late = donor.donorInfo.late_by_60_days ? 60 : (donor.donorInfo.late_by_30_days ? 30 : false)">
            <i class="fa fa-circle circle-late" ng-switch-when="30"
               uib-tooltip="{{$ctrl.gettextCatalog.getString('30 days late') }}" aria-hidden="true"></i>
            <i class="fa fa-circle circle-very-late" ng-switch-when="60"
               uib-tooltip="{{$ctrl.gettextCatalog.getString('60 days late')}}" aria-hidden="true"></i>
          </span>
                </td>

                <td ng-if="$ctrl.expanded">
                    {{donor.donorInfo.status}}
                </td>
                <td ng-if="$ctrl.expanded">
                    {{currencyGroup.currencySymbol}}{{donor.donorInfo.pledge_amount | number:0}}
                    {{currencyGroup.currency}}
                    {{donor.donorInfo.pledge_frequency}}
                </td>
                <td class="text-right" ng-if="$ctrl.expanded">
          <span ng-if="!$ctrl.useConvertedValues">
            {{donor.aggregates.average | number:0}}
          </span>
                    <span ng-if="$ctrl.useConvertedValues">
            {{donor.aggregatesConverted.average | number:0}}
          </span>
                </td>
                <td class="text-right" ng-if="$ctrl.expanded">
          <span ng-if="!$ctrl.useConvertedValues">
            {{donor.aggregates.min | number:0}}
          </span>
                    <span ng-if="$ctrl.useConvertedValues">
            {{donor.aggregatesConverted.min | number:0}}
          </span>
                </td>

                <td class="text-right" ng-repeat="donation in donor.donations track by $index">
                    <div uib-popover-template="'inline/currencyDonationsReport/donationDetailsTooltip.html'"
                         popover-trigger="mouseenter">
                        <span ng-if="donation.amount !== 0 && !$ctrl.useConvertedValues" ng-class="{'excluded': $last}">{{donation.amount | number:0}}</span>
                        <span ng-if="donation.amountConverted !== 0 && $ctrl.useConvertedValues"
                              ng-class="{'excluded': $last}">{{donation.amountConverted | number:0}}</span>
                        <script type="text/ng-template" id="inline/currencyDonationsReport/donationDetailsTooltip.html">
                            <strong translate>Monthly Total</strong>
                            <div>{{donation.currencySymbol}}{{donation.amount | number:0}} {{donation.currency}}</div>
                            <div><span translate>Converted</span>:
                                {{donation.currencySymbolConverted}}{{donation.amountConverted | number:0}}
                                {{donation.currencyConverted}}
                            </div>
                            <table class="table table-condensed">
                                <thead>
                                <tr>
                                    <th translate>Date</th>
                                    <th class="text-right" translate>Amount</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr ng-repeat="rawDonation in donation.rawDonations">
                                    <td>{{$ctrl.moment(rawDonation.donation_date).format('MMM Do')}}</td>
                                    <td class="text-right">{{rawDonation.currencySymbol}}{{rawDonation.amount |
                                        number:0}} {{rawDonation.currency}}
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </script>
                    </div>
                </td>
                <td class="text-right">
                    <strong ng-if="!$ctrl.useConvertedValues">{{currencyGroup.currencySymbol}}{{donor.aggregates.sum |
                        number:0}}</strong>
                    <strong ng-if="$ctrl.useConvertedValues">{{currencyGroup.currencySymbolConverted}}{{donor.aggregatesConverted.sum
                        | number:0}}</strong>
                </td>
            </tr>
            <tr class="row-total">
                <td colspan="{{$ctrl.expanded ? 5 : 1}}">
                    <strong translate>Totals</strong>
                </td>
                <td class="text-right" ng-repeat="monthTotal in currencyGroup.monthlyTotals track by $index">
                    <strong ng-if="!$ctrl.useConvertedValues" ng-class="{'excluded': $last}">{{currencyGroup.currencySymbol}}{{monthTotal.amount
                        | number:0}}</strong>
                    <strong ng-if="$ctrl.useConvertedValues" ng-class="{'excluded': $last}">{{currencyGroup.currencySymbolConverted}}{{monthTotal.amountConverted
                        | number:0}}</strong>
                </td>
                <td class="text-right">
                    <strong ng-if="!$ctrl.useConvertedValues">{{currencyGroup.currencySymbol}}{{currencyGroup.yearTotal
                        | number:0}}</strong>
                    <strong ng-if="$ctrl.useConvertedValues">{{currencyGroup.currencySymbolConverted}}{{currencyGroup.yearTotalConverted
                        | number:0}}</strong>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
